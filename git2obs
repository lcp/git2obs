#!/bin/sh

CONFIG_FILE=$HOME/.git2obsrc
LOG_FILE=/tmp/git2obs.$$

usage ()
{
	echo "Usage: git2obs directory version_prefix"
	exit 1
}

###
# we want pretty messages!

# COLS & COL
if [ "$COLS" ] && [ "$COLS" -gt 6 ]; then
	COL=`expr $COLS - 7`
else
	COLS=80
	COL=73
fi


if [ "$COLS" ] && [ "$COLS" -gt 6 ]; then
	COL=`expr $COLS - 7`
else
	COLS=80
	COL=73
fi

log_message ()
{
	echo -n " * $1"
}

log_message_end ()
{
	if [ -z "$1" ]; then
		return 1
	fi

	printf "\r"
	tput hpa $COL
	if [ "$1" -eq 0 ]; then
		printf '[ '
		tput setaf 2 # green
		printf OK
		tput op # normal
		echo ' ]'
	else
		printf '['
		tput setaf 1 # red
		printf fail
		tput op # normal
		echo ']'
	fi

	return $1
}

###
# okko message command
okko ()
{
	local message=$1
	local command=$2
	local result

	log_message "$message"
	echo "\$ $command" >> $LOG_FILE
	$command 2>&1 >> $LOG_FILE
        result=$?
	log_message_end $result
	if [ $result != 0 ]; then
		echo "Ooops... an error occured, see $LOG_FILE"
	fi
}

[ -f "$CONFIG_FILE" ] && source $CONFIG_FILE

# options
[ -z "$1" -o -z "$2" ] && usage
PACKAGE=`basename "$1`
PKG_PATH=`echo "$1" | sed -e 's,/$,,`
VERSION_PREFIX=$2

# default values
[ -z "$G2O_SANDBOX_CHECKOUT" ] && G2O_SANDBOX_CHECKOUT=$HOME/moblin/UX
[ -z "$G2O_COMMIT_AUTHOR" ] && {
	G2O_COMMIT_AUTHOR="Damien Lespiau <damien.lespiau@intel.com>"
}

# input validation
[ -d "$PKG_PATH" ] || {
	echo "$PKG_PATH is not a directory."
	exit 1
}
[ -d "$G2O_SANDBOX_CHECKOUT/$PACKAGE" ] || {
	echo "$G2O_SANDBOX_CHECKOUT/$PACKAGE is not a directory."
	exit 1
}
[ -f "$G2O_SANDBOX_CHECKOUT/$PACKAGE/$PACKAGE.ini" ] || {
	echo "Could not find $G2O_SANDBOX_CHECKOUT/$PACKAGE.ini"
	exit 1
}
[ -f "$G2O_SANDBOX_CHECKOUT/$PACKAGE/$PACKAGE.changes" ] || {
	echo "Could not find $PACKAGE.changes"
	exit 1
}

DATE=`date +%Y%m%d`
VP=$VERSION_PREFIX

# be sure nothing is in the way
[ -d "/tmp/$PACKAGE-$VP$DATE" ] && {
	echo "/tmp/$PACKAGE-$VP$DATE is in the way, please remove it."
	exit 1
}
[ -d "/tmp/$PACKAGE-$VP$DATE.tar.bz2" ] && {
	echo "/tmp/$PACKAGE-$VP$DATE.tar.bz2 is in the way, please remove it."
	exit 1
}

# we just copy the whole directory, run git clean -xdf in it, remove .git
# and create a tarbal
cp -r $PKG_PATH /tmp/$PACKAGE-$VP$DATE
cd /tmp/$PACKAGE-$VP$DATE
COMMIT_HASH=`git show-ref -s HEAD | head -n 1`
git clean -xdf
rm -rf .git
cd -
tar -C /tmp -jcf $PACKAGE-$VP$DATE.tar.bz2 $PACKAGE-$VP$DATE
mv $PACKAGE-$VP$DATE.tar.bz2 $G2O_SANDBOX_CHECKOUT/$PACKAGE
[ -d /tmp/$PACKAGE-$VP$DATE ] && rm -rf /tmp/$PACKAGE-$VP$DATE

# update spec-builder metadata
COMMIT_DATE=`date +'%a %b %d %Y'`
cd $G2O_SANDBOX_CHECKOUT/$PACKAGE
# add update info in .changes file
mv $PACKAGE.changes $PACKAGE.changes.orig
echo "* $COMMIT_DATE $G2O_COMMIT_AUTHOR $VP$DATE" > $PACKAGE.changes
echo "- Update to commit $COMMIT_HASH" >> $PACKAGE.changes
echo "" >> $PACKAGE.changes
cat $PACKAGE.changes.orig >> $PACKAGE.changes
rm $PACKAGE.changes.orig
# update the version in the ini file
sed -i -e "s,Version.*,Version = $VP$DATE," $PACKAGE.ini
# run spec-builder to update the spec file
spec-builder $PACKAGE.ini > $PACKAGE.spec

